# exploit/ftp_enum.py
"""
FTP Enumeration Module
- Full FTP enumeration (banner, features, anonymous, users)
- Progress bar dengan tqdm
- Output di Panel + Table
- Termux 100% jalan
"""

from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from tqdm import tqdm
import socket
import time
import sys

console = Console()

# Daftar user untuk brute force (bisa diperluas)
USER_LIST = ["anonymous", "ftp", "admin", "test", "user", "root"]

# Port default
FTP_PORT = 21

def ftp_connect(ip, port, timeout=5):
    """Connect ke FTP server"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        sock.connect((ip, port))
        banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
        return sock, banner
    except:
        return None, None

def ftp_send(sock, command):
    """Kirim command ke FTP"""
    try:
        sock.send((command + "\r\n").encode('utf-8'))
        response = sock.recv(1024).decode('utf-8', errors='ignore')
        return response.strip()
    except:
        return None

def ftp_login(sock, user, password=""):
    """Login FTP"""
    try:
        resp = ftp_send(sock, f"USER {user}")
        if resp and ("331" in resp or "230" in resp):
            resp_pass = ftp_send(sock, f"PASS {password}")
            if "230" in resp_pass:
                return True, "Login successful"
            elif "530" in resp_pass:
                return False, "Wrong password"
        return False, resp or "No response"
    except:
        return False, "Connection error"

def get_ftp_features(sock):
    """Ambil fitur FTP (SYST, FEAT)"""
    features = {}
    try:
        syst = ftp_send(sock, "SYST")
        if syst: features["SYST"] = syst.split(" ", 1)[1] if " " in syst else syst
        feat = ftp_send(sock, "FEAT")
        if feat and "211" in feat.splitlines()[0]:
            lines = feat.splitlines()[1:-1]
            features["Features"] = ", ".join([f.strip().split()[0] for f in lines if f.strip()])
    except:
        pass
    return features

def run_exploit(target):
    port = FTP_PORT
    console.print(f"[*] FTP Enumeration â†’ {target}:{port}")

    # --- PROGRESS BAR (tqdm) ---
    with tqdm(
        total=len(USER_LIST),
        desc="Enumerating FTP",
        bar_format="{l_bar}{bar}| {n_fmt}/{total_fmt} [{elapsed}]",
        colour="cyan",
        file=sys.stdout
    ) as pbar:

        # 1. Connect
        pbar.set_postfix_str("connecting...")
        sock, banner = ftp_connect(target, port)
        if not sock:
            pbar.close()
            console.print(Panel("FTP server not responding!", title="FAILED", style="red"))
            return "FAILED - No response"
        pbar.update(1)

        # 2. Banner
        pbar.set_postfix_str("banner grabbed")
        banner = banner.splitlines()[0] if banner else "Unknown"
        pbar.update(1)

        # 3. Anonymous login
        pbar.set_postfix_str("trying anonymous")
        anon_success, anon_msg = ftp_login(sock, "anonymous", "")
        pbar.update(1)

        # 4. Brute force users
        valid_users = []
        for user in USER_LIST[1:]:  # Skip anonymous
            pbar.set_postfix_str(f"trying: {user}")
            success, msg = ftp_login(sock, user, "")
            if success:
                valid_users.append(user)
            pbar.update(1)
            time.sleep(0.3)  # Biar progress bar terlihat

        # 5. Features (jika login sukses)
        features = {}
        if anon_success or valid_users:
            pbar.set_postfix_str("grabbing features")
            features = get_ftp_features(sock)
            pbar.update(1)
        sock.close()

    # --- TAMPILKAN HASIL ---
    table = Table(title="FTP Enumeration Results")
    table.add_column("Field", style="cyan")
    table.add_column("Value", style="white")

    table.add_row("Target", f"{target}:{port}")
    table.add_row("Banner", banner)
    table.add_row("Anonymous", "[bold green]YES[/]" if anon_success else "[bold red]NO[/]")
    table.add_row("Valid Users", ", ".join(valid_users) if valid_users else "[dim]none[/]")

    if features:
        for k, v in features.items():
            table.add_row(k, v)

    console.print(table)

    # --- PANEL SUKSES ---
    success_msg = f"FTP Enumeration Complete!\n"
    success_msg += f"Anonymous: {'YES' if anon_success else 'NO'}\n"
    success_msg += f"Valid Users: {', '.join(valid_users) if valid_users else 'none'}"

    console.print(Panel(
        success_msg,
        title="SUCCESS",
        style="green"
    ))

    return f"SUCCESS - {len(valid_users) + (1 if anon_success else 0)} credential(s) found"
